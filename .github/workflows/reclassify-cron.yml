name: Reclassify tokens (cron)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  call-cron-endpoint:
    runs-on: ubuntu-latest
    steps:
      - name: Sanity check (HEAD without secret)
        env:
          CRON_URL: ${{ secrets.CRON_URL }}
        run: |
          set -euo pipefail
          if [ -z "${CRON_URL:-}" ]; then echo "CRON_URL empty"; exit 1; fi
          code=$(curl -sS -o /dev/null -w "%{http_code}" -I "$CRON_URL")
          echo "HEAD status: $code"
          if [ "$code" = "404" ]; then echo "Not found (bad path)"; exit 1; fi

      - name: Call CRON endpoint (POST with secret)
        env:
          CRON_URL: ${{ secrets.CRON_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${CRON_SECRET:-}" ]; then echo "CRON_SECRET empty"; exit 1; fi

          STATUS=$(curl -sS -X POST "$CRON_URL" \
            -H "Content-Type: application/json" \
            -H "X-CRON-SECRET: $CRON_SECRET" \
            -o /tmp/body.txt -w "%{http_code}")

          echo "HTTP $STATUS"
          echo "---- Response body ----"
          cat /tmp/body.txt

          test "$STATUS" -lt 400
