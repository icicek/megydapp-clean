name: Reclassify tokens (cron)

on:
  schedule:
    - cron: "0 */12 * * *" # every 12 hours (UTC)
  # Elle tetiklemek için:
  workflow_dispatch:
    inputs:
      force:
        description: "Cooldown'ı bypass et (1 = evet)"
        required: false
        default: "0"

concurrency:
  group: reclassify-cron
  cancel-in-progress: false

jobs:
  call-cron-endpoint:
    name: Call CRON endpoint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Resolve envs (prefer secrets, fallback to vars)
        id: prep
        env:
          CRON_URL_SECRET: ${{ secrets.CRON_URL }}   # e.g. https://<site>/api/admin/reclassify
          CRON_URL_VAR:    ${{ vars.CRON_URL }}
          CRON_SECRET_S:   ${{ secrets.CRON_SECRET }}
          CRON_SECRET_V:   ${{ vars.CRON_SECRET }}
        run: |
          set -euo pipefail
          CRON_URL="${CRON_URL_SECRET:-${CRON_URL_VAR:-}}"
          CRON_SECRET="${CRON_SECRET_S:-${CRON_SECRET_V:-}}"

          if [ -z "${CRON_URL:-}" ]; then
            echo "CRON_URL eksik (örn: https://<site>/api/admin/reclassify)"; exit 1;
          fi
          if [ -z "${CRON_SECRET:-}" ]; then
            echo "CRON_SECRET eksik"; exit 1;
          fi

          # Toggle endpoint: /api/admin/config/cron_enabled
          # CRON_URL: .../api/admin/reclassify
          BASE="${CRON_URL%/api/admin/reclassify}"
          CONFIG_URL="${BASE}/api/admin/config/cron_enabled"

          echo "cron_url=$CRON_URL" >> "$GITHUB_OUTPUT"
          echo "config_url=$CONFIG_URL" >> "$GITHUB_OUTPUT"

      - name: Check Cron Enabled (DB toggle) — skip early if disabled
        env:
          CONFIG_URL: ${{ steps.prep.outputs.config_url }}
        run: |
          set -euo pipefail
          BODY=$(curl -sS -L --retry 2 --retry-delay 2 \
            "$CONFIG_URL?v=$(date +%s)")

          echo "Toggle response: $BODY"

          # Expected: { "success": true, "value": "true"|"false" }
          ENABLED="true"
          if command -v jq >/dev/null 2>&1; then
            ENABLED=$(echo "$BODY" | jq -r '.value // "true"' | tr '[:upper:]' '[:lower:]')
          else
            # fallback: naive parse
            if echo "$BODY" | grep -qi '"value"[[:space:]]*:[[:space:]]*"false"'; then
              ENABLED="false"
            fi
          fi

          if [ "$ENABLED" != "true" ]; then
            echo "Cron disabled in DB (cron_enabled=false) — skipping without calling reclassify."
            {
              echo "### Reclassify cron — SKIPPED"
              echo ""
              echo "- Reason: cron_enabled=false"
              echo "- Config URL: $CONFIG_URL"
              echo ""
              echo '```json'
              echo "$BODY"
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

      - name: HEAD (sanity check)
        env:
          CRON_URL: ${{ steps.prep.outputs.cron_url }}
        run: |
          set amplification on
          set -euo pipefail
          CODE=$(curl -sS -I -L \
            --retry 2 --retry-delay 2 \
            -o /dev/null -w "%{http_code}" \
            "$CRON_URL?v=$(date +%s)")
          echo "HEAD status: $CODE"

          {
            echo "### Reclassify cron — HEAD"
            echo ""
            echo "- Event: **${{ github.event_name }}**"
            echo "- Ref: **${{ github.ref_name }}**"
            echo "- URL: $CRON_URL"
            echo "- Status: $CODE"
          } >> "$GITHUB_STEP_SUMMARY"

          # 404 = path yanlış; kabul edilenler: 200/204/405/308
          case "$CODE" in
            200|204|405|308) true ;;
            404) echo "Not found (bad path)"; exit 1 ;;
            *) true ;;
          esac

      - name: POST (trigger endpoint)
        env:
          CRON_URL: ${{ steps.prep.outputs.cron_url }}
          CRON_SECRET_S: ${{ secrets.CRON_SECRET }}
          CRON_SECRET_V: ${{ vars.CRON_SECRET }}
        run: |
          set -euo pipefail
          CRON_SECRET="${CRON_SECRET_S:-${CRON_SECRET_V:-}}"

          URL="$CRON_URL?v=$(date +%s)"
          # Manuel tetiklemede force=1 isteğe bağlı
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force }}" = "1" ]; then
            URL="${URL}&force=1"
          fi

          STATUS=$(curl -sS -L -X POST "$URL" \
            -H "X-CRON-SECRET: $CRON_SECRET" \
            --retry 2 --retry-delay 2 \
            -o /tmp/body.json -w "%{http_code}")

          echo "HTTP $STATUS"
          echo "---- Response body ----"
          cat /tmp/body.json || true

          {
            echo "### Reclassify cron — POST"
            echo ""
            echo "- URL: $URL"
            echo "- HTTP: **$STATUS**"
            echo ""
            echo '```json'
            cat /tmp/body.json || true
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

          # 503 CRON_DISABLED ise 'skipped' say ve hataya düşme
          if [ "$STATUS" = "503" ]; then
            if command -v jq >/dev/null 2>&1; then
              ERR=$(jq -r '.error // empty' /tmp/body.json 2>/dev/null || true)
              if [ "$ERR" = "CRON_DISABLED" ]; then
                echo "Cron disabled — skipping without failure."
                exit 0
              fi
            else
              echo "503 received — treating as skipped."
              exit 0
            fi
          fi

          # Diğer HTTP hatalarında fail
          if [ "$STATUS" -ge 400 ]; then
            exit 1
          fi

          # JSON 'ok:false' ise fail (jq varsa kontrol)
          if command -v jq >/dev/null 2>&1; then
            OK=$(jq -r '.ok // empty' /tmp/body.json 2>/dev/null || true)
            if [ "$OK" != "true" ]; then
              echo "Endpoint ok:false döndürdü veya JSON geçersiz"; exit 1
            fi
          fi
